name: workflow control

on: 
  pull_request_target:
    types: [opened, synchronize, labeled, closed]
    paths:
      '.github/workflows/**'

jobs:
  check-actions:
    name: check actions
    runs-on: ubuntu-20.04

    steps:
    - name: wait 20 sec
      run: sleep 20
    - if: contains(github.event.pull_request.labels.*.name, 'update CI') != true
      name: cancel workflows
      uses: actions/github-script@v3
      with:
        github-token: ${{ secrets.CANCEL_WORKFLOW_TOKEN }}
        debug: true
        script: |
            const branch = context.ref.replace('refs/heads/', '')
            // Get a list of all issues created by the PR opener
            // See: https://octokit.github.io/rest.js/#pagination
            const creator = context.payload.sender.login
            const opts1 = github.actions.listWorkflowRunsForRepo.endpoint.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              branch,
              event: 'pull_request',
            })
            const workflows = await github.paginate(opts1)
            console.log(workflows);
            for (const workflow of workflows) {
              if (workflow.status == 'completed') continue
              if (workflow.run_number == context.runNumber) continue
              // if (workflow.head_sha != context.sha) continue
              await github.actions.cancelWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: workflow.id
              })
              console.log(`cancel id: ${workflow.id}`);
            }
    - if: contains(github.event.pull_request.labels.*.name, 'update CI') != true
      run: exit 1
    - if: success()
      run: echo "enabled editing workflow."
